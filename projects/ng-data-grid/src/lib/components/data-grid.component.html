<div 
  class="ng-data-grid"
  [class.rtl]="options.rtl"
  [class.dark-theme]="options.theme === 'dark'"
  [class.light-theme]="options.theme === 'light'"
  [attr.role]="'grid'"
  [attr.aria-label]="'Data Grid'"
  #gridContainer>
  
  <!-- Group Panel -->
  <div class="group-panel">
    <div class="group-panel-header">
      <span class="group-panel-title">Group By:</span>
      <button 
        class="group-panel-toggle"
        (click)="toggleGroupPanel()"
        [attr.aria-label]="showGroupPanel ? 'Hide group panel' : 'Show group panel'">
        {{ showGroupPanel ? '−' : '+' }}
      </button>
    </div>
    
    <div class="group-panel-content" *ngIf="showGroupPanel || getCurrentGroups().length > 0">
      <!-- Drop Zone -->
      <div 
        class="group-drop-zone"
        (dragover)="onGroupPanelDragOver($event)"
        (drop)="onGroupPanelDrop($event)"
        [class.drag-over]="draggedColumn !== null">
        <span class="drop-zone-text" *ngIf="getCurrentGroups().length === 0">
          Drag a column here to group by it
        </span>
        <span class="drop-zone-text" *ngIf="getCurrentGroups().length > 0 && draggedColumn">
          Drop column to add grouping
        </span>
        <span class="drop-zone-text" *ngIf="getCurrentGroups().length > 0 && !draggedColumn" style="display: none;"></span>
      </div>
      
      <!-- Active Groups -->
      <div class="group-items" *ngIf="getCurrentGroups().length > 0">
        <div 
          *ngFor="let group of getCurrentGroups(); let i = index; trackBy: trackByGroup"
          class="group-item"
          [class.dragging]="draggedGroupIndex === i"
          [class.drag-over]="dragOverIndex === i"
          [attr.draggable]="'true'"
          (dragstart)="onGroupItemDragStart(group, i, $event)"
          (dragover)="onGroupItemDragOver(i, $event)"
          (drop)="onGroupItemDrop(i, $event)"
          (dragend)="draggedGroupIndex = -1; dragOverIndex = -1">
          <span class="group-item-icon">≡</span>
          <span class="group-item-label">
            {{ getColumnTitle(group.field) }}
          </span>
          <button 
            class="group-item-direction"
            (click)="toggleGroupDirection(i)"
            [attr.aria-label]="'Toggle sort direction'">
            {{ group.direction === 'asc' ? '↑' : '↓' }}
          </button>
          <button 
            class="group-item-remove"
            (click)="removeGroup(i)"
            [attr.aria-label]="'Remove group'">
            ×
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Search Bar -->
  <div class="grid-search" *ngIf="options.enableSearch">
    <div class="search-container">
      <input 
        type="text"
        class="search-input"
        [placeholder]="options.searchPlaceholder || 'Search...'"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange($event)"
        [attr.aria-label]="'Search grid data'">
      <button 
        class="search-clear"
        *ngIf="searchTerm"
        (click)="clearSearch()"
        [attr.aria-label]="'Clear search'">
        ×
      </button>
    </div>
  </div>
  
  <!-- Header -->
  <div class="grid-header" *ngIf="options.showHeader !== false" [style.height.px]="headerHeight">
    <div class="header-row" #headerRow>
      <!-- Select All Checkbox -->
      <div class="header-cell header-cell-select" *ngIf="options.selectionMode === 'multiple'">
        <div class="header-content">
          <input 
            type="checkbox" 
            [checked]="isAllSelected()"
            [indeterminate]="isIndeterminate()"
            (change)="onSelectAll($event)"
            [attr.aria-label]="'Select all rows'">
        </div>
      </div>
      
      <!-- Row Number Header -->
      <div class="header-cell header-cell-number" *ngIf="options.showRowNumbers">
        <div class="header-content">
          <span>#</span>
        </div>
      </div>
      
      <!-- Pinned Left Columns -->
      <div 
        *ngFor="let column of pinnedLeftColumns; trackBy: trackByColumn; let i = index"
        class="header-cell header-cell-pinned-left"
        [class.sortable]="column.sortable"
        [class.has-filter]="options.enableColumnFilters && column.filterable !== false"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [attr.draggable]="options.columnReorder ? 'true' : null"
        (click)="onColumnHeaderClick(column, $event)"
        (dragstart)="onColumnDragStart(column, $event)"
        (dragover)="onColumnDragOver(column, i, $event)"
        (drop)="onColumnDrop(column, i, $event)"
        (dragend)="onColumnDragEnd()"
        [attr.aria-sort]="getSortDirection(column)">
        <div class="header-content">
          <ng-container *ngIf="column.headerTemplate; else defaultHeader">
            <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
          </ng-container>
          <ng-template #defaultHeader>
            <span class="header-title">{{ column.title || column.field }}</span>
          </ng-template>
          <span class="sort-indicator" *ngIf="column.sortable">
            <span *ngIf="getSortDirection(column) === 'asc'">↑</span>
            <span *ngIf="getSortDirection(column) === 'desc'">↓</span>
          </span>
        </div>
        <!-- Column Filter -->
        <div class="column-filter" *ngIf="options.enableColumnFilters && column.filterable !== false">
          <input 
            type="text"
            class="filter-input"
            [placeholder]="'Filter ' + (column.title || column.field)"
            [value]="columnFilters[column.field] || ''"
            (input)="onColumnFilterChange(column.field, $any($event.target).value)"
            (keyup)="onColumnFilterChange(column.field, $any($event.target).value)"
            (paste)="onColumnFilterChange(column.field, $any($event.target).value)"
            (click)="$event.stopPropagation()"
            [attr.aria-label]="'Filter ' + (column.title || column.field)">
        </div>
        <div 
          class="resize-handle" 
          *ngIf="column.resizable"
          (mousedown)="onColumnResizeStart(column, $event)">
        </div>
      </div>
      
      <!-- Normal Columns -->
      <div 
        *ngFor="let column of normalColumns; trackBy: trackByColumn; let i = index"
        class="header-cell"
        [class.sortable]="column.sortable"
        [class.has-filter]="options.enableColumnFilters && column.filterable !== false"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [attr.draggable]="options.columnReorder ? 'true' : null"
        (click)="onColumnHeaderClick(column, $event)"
        (dragstart)="onColumnDragStart(column, $event)"
        (dragover)="onColumnDragOver(column, i, $event)"
        (drop)="onColumnDrop(column, i, $event)"
        (dragend)="onColumnDragEnd()"
        [attr.aria-sort]="getSortDirection(column)">
        <div class="header-content">
          <ng-container *ngIf="column.headerTemplate; else defaultHeader">
            <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
          </ng-container>
          <ng-template #defaultHeader>
            <span class="header-title">{{ column.title || column.field }}</span>
          </ng-template>
          <span class="sort-indicator" *ngIf="column.sortable">
            <span *ngIf="getSortDirection(column) === 'asc'">↑</span>
            <span *ngIf="getSortDirection(column) === 'desc'">↓</span>
          </span>
        </div>
        <!-- Column Filter -->
        <div class="column-filter" *ngIf="options.enableColumnFilters && column.filterable !== false">
          <input 
            type="text"
            class="filter-input"
            [placeholder]="'Filter ' + (column.title || column.field)"
            [value]="columnFilters[column.field] || ''"
            (input)="onColumnFilterChange(column.field, $any($event.target).value)"
            (keyup)="onColumnFilterChange(column.field, $any($event.target).value)"
            (paste)="onColumnFilterChange(column.field, $any($event.target).value)"
            (click)="$event.stopPropagation()"
            [attr.aria-label]="'Filter ' + (column.title || column.field)">
        </div>
        <div 
          class="resize-handle" 
          *ngIf="column.resizable"
          (mousedown)="onColumnResizeStart(column, $event)">
        </div>
      </div>
      
      <!-- Pinned Right Columns -->
      <div 
        *ngFor="let column of pinnedRightColumns; trackBy: trackByColumn; let i = index"
        class="header-cell header-cell-pinned-right"
        [class.sortable]="column.sortable"
        [class.has-filter]="options.enableColumnFilters && column.filterable !== false"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [attr.draggable]="options.columnReorder ? 'true' : null"
        (click)="onColumnHeaderClick(column, $event)"
        (dragstart)="onColumnDragStart(column, $event)"
        (dragover)="onColumnDragOver(column, i, $event)"
        (drop)="onColumnDrop(column, i, $event)"
        (dragend)="onColumnDragEnd()"
        [attr.aria-sort]="getSortDirection(column)">
        <div class="header-content">
          <ng-container *ngIf="column.headerTemplate; else defaultHeader">
            <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
          </ng-container>
          <ng-template #defaultHeader>
            <span class="header-title">{{ column.title || column.field }}</span>
          </ng-template>
          <span class="sort-indicator" *ngIf="column.sortable">
            <span *ngIf="getSortDirection(column) === 'asc'">↑</span>
            <span *ngIf="getSortDirection(column) === 'desc'">↓</span>
          </span>
        </div>
        <!-- Column Filter -->
        <div class="column-filter" *ngIf="options.enableColumnFilters && column.filterable !== false">
          <input 
            type="text"
            class="filter-input"
            [placeholder]="'Filter ' + (column.title || column.field)"
            [value]="columnFilters[column.field] || ''"
            (input)="onColumnFilterChange(column.field, $any($event.target).value)"
            (keyup)="onColumnFilterChange(column.field, $any($event.target).value)"
            (paste)="onColumnFilterChange(column.field, $any($event.target).value)"
            (click)="$event.stopPropagation()"
            [attr.aria-label]="'Filter ' + (column.title || column.field)">
        </div>
        <div 
          class="resize-handle" 
          *ngIf="column.resizable"
          (mousedown)="onColumnResizeStart(column, $event)">
        </div>
      </div>
    </div>
  </div>
  
  <!-- Body -->
  <div class="grid-body" #bodyContainer [style.height.px]="options.virtualScroll ? 400 : null" [style.overflow-y]="options.virtualScroll ? 'auto' : null">
    <!-- Loading Indicator -->
    <div class="loading-indicator" *ngIf="loading">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>
    
    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && data.length === 0">
      <ng-container *ngIf="options.emptyTemplate; else defaultEmpty">
        <ng-container *ngTemplateOutlet="options.emptyTemplate"></ng-container>
      </ng-container>
      <ng-template #defaultEmpty>
        <span>No data available</span>
      </ng-template>
    </div>
    
    <!-- Virtual Scroll Spacer (top) -->
    <div *ngIf="options.virtualScroll" [style.height.px]="virtualScrollStart * rowHeight"></div>
    
    <!-- Rows -->
    <ng-container *ngFor="let row of getVisibleRows(); trackBy: trackByRow; let i = index">
      <!-- Group Row -->
      <div 
        *ngIf="isGroupRowType(row)"
        class="grid-row group-row"
        [class.expanded]="row.expanded"
        [style.height.px]="rowHeight"
        [style.top.px]="options.virtualScroll ? (virtualScrollStart + i) * rowHeight : null"
        [style.padding-left.px]="row.level * 20"
        (click)="onRowClick(row, virtualScrollStart + i, $event)"
        [attr.aria-expanded]="row.expanded"
        [attr.aria-rowindex]="virtualScrollStart + i + 1"
        [attr.role]="'row'">
        
        <!-- Select Checkbox (empty for group) -->
        <div class="cell cell-select" *ngIf="options.selectionMode === 'multiple'"></div>
        
        <!-- Row Number (empty for group) -->
        <div class="cell cell-number" *ngIf="options.showRowNumbers"></div>
        
        <!-- Group Indicator and Value - spans all columns -->
        <div class="cell group-cell" [style.flex]="'1 1 auto'">
          <span class="group-indicator" [class.expanded]="row.expanded">
            {{ row.expanded ? '▼' : '▶' }}
          </span>
          <span class="group-label">
            <strong>{{ getColumnTitle(row.field) }}:</strong> {{ row.value ?? '(null)' }} - {{ row.count }} items
          </span>
          
          <!-- Group Aggregates (all aggregates inline) -->
          <span class="group-aggregates" *ngIf="row.aggregates && row.aggregates.length > 0">
            <span *ngFor="let agg of row.aggregates" class="aggregate-inline">
              {{ getColumnTitle(agg.field) }} {{ agg.aggregate }}: {{ formatAggregateValue(agg.value, agg.aggregate, getColumnByField(agg.field)) }}
            </span>
          </span>
        </div>
      </div>
      
      <!-- Data Row -->
      <div 
        *ngIf="!isGroupRowType(row)"
        class="grid-row"
        [class.selected]="isRowSelected(row)"
        [class.current]="currentRow === row"
        [class.editing]="editingRow === row"
        [style.height.px]="rowHeight"
        [style.top.px]="options.virtualScroll ? (virtualScrollStart + i) * rowHeight : null"
        (click)="onRowClick(row, virtualScrollStart + i, $event)"
        (dblclick)="onRowDoubleClick(row, virtualScrollStart + i, $event)"
        [attr.aria-selected]="isRowSelected(row)"
        [attr.aria-rowindex]="virtualScrollStart + i + 1"
        [attr.role]="'row'">
      
      <!-- Select Checkbox -->
      <div class="cell cell-select" *ngIf="options.selectionMode === 'multiple'">
        <input 
          type="checkbox" 
          [checked]="isRowSelected(row)"
          (click)="onRowSelect(row, $event); $event.stopPropagation()"
          [attr.aria-label]="'Select row ' + (virtualScrollStart + i + 1)">
      </div>
      
      <!-- Row Number -->
      <div class="cell cell-number" *ngIf="options.showRowNumbers">
        <span>{{ virtualScrollStart + i + 1 }}</span>
      </div>
      
      <!-- Pinned Left Cells -->
      <div 
        *ngFor="let column of pinnedLeftColumns; trackBy: trackByColumn"
        class="cell cell-pinned-left"
        [class.editing]="editingCell?.row === row && editingCell?.field === column.field"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [style.text-align]="column.align || 'left'"
        (click)="onCellClick(row, column, virtualScrollStart + i, pinnedLeftColumns.indexOf(column), $event)"
        (dblclick)="onCellDoubleClick(row, column, virtualScrollStart + i, pinnedLeftColumns.indexOf(column), $event)"
        [attr.role]="'gridcell'"
        [attr.aria-colindex]="pinnedLeftColumns.indexOf(column) + 1">
        <ng-container *ngIf="editingCell?.row === row && editingCell?.field === column.field && column.editable; else displayCell">
          <input 
            type="text"
            class="cell-input"
            [value]="getFieldValue($any(row), column.field)"
            (blur)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.enter)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.escape)="cancelCellEdit()"
            (click)="$event.stopPropagation()">
        </ng-container>
        <ng-template #displayCell>
          <ng-container *ngIf="column.cellTemplate; else defaultCell">
            <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: $any(row), column: column, value: getFieldValue($any(row), column.field) }"></ng-container>
          </ng-container>
          <ng-template #defaultCell>
            <span>{{ formatCellValue(getFieldValue($any(row), column.field), $any(row), column) }}</span>
          </ng-template>
        </ng-template>
      </div>
      
      <!-- Normal Cells -->
      <div 
        *ngFor="let column of normalColumns; trackBy: trackByColumn"
        class="cell"
        [class.editing]="editingCell?.row === row && editingCell?.field === column.field"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [style.text-align]="column.align || 'left'"
        (click)="onCellClick(row, column, virtualScrollStart + i, normalColumns.indexOf(column), $event)"
        (dblclick)="onCellDoubleClick(row, column, virtualScrollStart + i, normalColumns.indexOf(column), $event)"
        [attr.role]="'gridcell'"
        [attr.aria-colindex]="normalColumns.indexOf(column) + 1">
        <ng-container *ngIf="editingCell?.row === row && editingCell?.field === column.field && column.editable; else displayCell">
          <input 
            type="text"
            class="cell-input"
            [value]="getFieldValue($any(row), column.field)"
            (blur)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.enter)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.escape)="cancelCellEdit()"
            (click)="$event.stopPropagation()">
        </ng-container>
        <ng-template #displayCell>
          <ng-container *ngIf="column.cellTemplate; else defaultCell">
            <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: $any(row), column: column, value: getFieldValue($any(row), column.field) }"></ng-container>
          </ng-container>
          <ng-template #defaultCell>
            <span>{{ formatCellValue(getFieldValue($any(row), column.field), $any(row), column) }}</span>
          </ng-template>
        </ng-template>
      </div>
      
      <!-- Pinned Right Cells -->
      <div 
        *ngFor="let column of pinnedRightColumns; trackBy: trackByColumn"
        class="cell cell-pinned-right"
        [class.editing]="editingCell?.row === row && editingCell?.field === column.field"
        [style.width.px]="column.width || 100"
        [style.min-width.px]="column.minWidth || 50"
        [style.max-width.px]="column.maxWidth || 1000"
        [style.text-align]="column.align || 'left'"
        (click)="onCellClick(row, column, virtualScrollStart + i, pinnedRightColumns.indexOf(column), $event)"
        (dblclick)="onCellDoubleClick(row, column, virtualScrollStart + i, pinnedRightColumns.indexOf(column), $event)"
        [attr.role]="'gridcell'"
        [attr.aria-colindex]="pinnedRightColumns.indexOf(column) + 1">
        <ng-container *ngIf="editingCell?.row === row && editingCell?.field === column.field && column.editable; else displayCell">
          <input 
            type="text"
            class="cell-input"
            [value]="getFieldValue($any(row), column.field)"
            (blur)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.enter)="saveCellEdit($any(row), column, $any($event.target).value)"
            (keydown.escape)="cancelCellEdit()"
            (click)="$event.stopPropagation()">
        </ng-container>
        <ng-template #displayCell>
          <ng-container *ngIf="column.cellTemplate; else defaultCell">
            <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: $any(row), column: column, value: getFieldValue($any(row), column.field) }"></ng-container>
          </ng-container>
          <ng-template #defaultCell>
            <span>{{ formatCellValue(getFieldValue($any(row), column.field), $any(row), column) }}</span>
          </ng-template>
        </ng-template>
      </div>
      </div>
    </ng-container>
    
    <!-- Virtual Scroll Spacer (bottom) -->
    <div *ngIf="options.virtualScroll" [style.height.px]="(getVisibleRows().length - virtualScrollEnd) * rowHeight"></div>
    
    <!-- Infinite Scroll Loading Indicator -->
    <div *ngIf="options.infiniteScroll && isLoadingMore" class="infinite-scroll-loading">
      <div class="loading-spinner">Loading more...</div>
    </div>
    
    <!-- Infinite Scroll End Message -->
    <div *ngIf="options.infiniteScroll && !hasMoreData && data.length > 0" class="infinite-scroll-end">
      <div class="end-message">No more data to load</div>
    </div>
  </div>
  
  <!-- Footer -->
  <div class="grid-footer" *ngIf="options.showFooter !== false">
    <!-- Footer Aggregates -->
    <div class="footer-aggregates" *ngIf="footerAggregates.length > 0">
      <div class="aggregate-row">
        <span *ngFor="let agg of footerAggregates; let last = last" class="aggregate-item">
          <strong>{{ formatAggregateLabel(agg.field, agg.aggregate) }}:</strong> 
          {{ formatAggregateValue(agg.value, agg.aggregate, getColumnByField(agg.field)) }}
          <span *ngIf="!last" class="aggregate-separator"> | </span>
        </span>
      </div>
    </div>
    
    <div class="footer-content">
      <div class="footer-info">
        <span *ngIf="getCurrentGroups().length === 0">
          Showing {{ getVisibleRows().length }} of {{ total }} rows
        </span>
        <span *ngIf="getCurrentGroups().length > 0">
          Showing {{ getVisibleDataRowsCount() }} of {{ total }} data rows
          <span *ngIf="getVisibleGroupRowsCount() > 0">
            ({{ getVisibleGroupRowsCount() }} group rows)
          </span>
        </span>
      </div>
      
      <!-- Pagination controls - hidden when grouping is enabled (uses infinite scroll instead) -->
      <div class="footer-pagination" *ngIf="options.pageSizeOptions && options.pageSizeOptions.length > 0 && !options.infiniteScroll && getCurrentGroups().length === 0">
        <select 
          [value]="pageSize" 
          (change)="onPageSizeChange(+$any($event.target).value)"
          [attr.aria-label]="'Page size'">
          <option *ngFor="let size of options.pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
        
        <div class="pagination-controls">
          <button 
            (click)="onPageChange(1)"
            [disabled]="currentPage === 1"
            [attr.aria-label]="'First page'">
            ««
          </button>
          <button 
            (click)="onPageChange(currentPage - 1)"
            [disabled]="currentPage === 1"
            [attr.aria-label]="'Previous page'">
            «
          </button>
          <span class="page-info">
            Page {{ currentPage }} of {{ getTotalPages() }}
          </span>
          <button 
            (click)="onPageChange(currentPage + 1)"
            [disabled]="currentPage >= getTotalPages()"
            [attr.aria-label]="'Next page'">
            »
          </button>
          <button 
            (click)="onPageChange(getTotalPages())"
            [disabled]="currentPage >= getTotalPages()"
            [attr.aria-label]="'Last page'">
            »»
          </button>
        </div>
      </div>
      
      <!-- Infinite scroll info when grouping is enabled -->
      <div class="footer-info-infinite" *ngIf="getCurrentGroups().length > 0">
        <span>Scroll to load more data</span>
        <span *ngIf="isLoadingMore" class="loading-indicator">Loading...</span>
        <span *ngIf="!hasMoreData && data.length > 0" class="end-indicator">All data loaded</span>
      </div>
      
      <div class="footer-actions" *ngIf="options.enableExport">
        <button (click)="exportData('csv')" [attr.aria-label]="'Export to CSV'">Export CSV</button>
        <button (click)="exportData('excel')" [attr.aria-label]="'Export to Excel'">Export Excel</button>
        <button (click)="exportData('pdf')" [attr.aria-label]="'Export to PDF'">Export PDF</button>
      </div>
    </div>
  </div>
</div>


